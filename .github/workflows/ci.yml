name: CI

on:
  push:
    branches: [ main, feature/** ]
  pull_request:

jobs:
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-audit-

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Run cargo audit
        run: cargo audit

      - name: Run cargo deny (licenses and advisories)
        run: cargo deny check advisories licenses
        continue-on-error: true  # Don't fail on license issues initially

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true

  build-test-smoke:
    runs-on: ubuntu-latest
    container: rust:1-bookworm
    timeout-minutes: 35
    env:
      # Override release profile for CI: disable LTO and use more codegen units
      CARGO_PROFILE_RELEASE_LTO: "false"
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: "16"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show disk space
        run: df -h /

      - name: Install system deps
        run: |
          apt-get update -qq
          apt-get install -y -qq curl jq lsof python3 build-essential nodejs npm

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/release
          key: ${{ runner.os }}-rust1-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust1-cargo-release-

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin >/dev/null 2>&1

      - name: Lint Documentation
        run: |
          task docs:lint

      - name: CI Pipeline (release without LTO for disk efficiency)
        run: |
          echo "üöÄ Lithair CI Pipeline"
          echo "‚úÖ Code formatting check..."
          cargo fmt -- --check >/dev/null 2>&1 && echo "   ‚úì Formatting OK" || (echo "   ‚úó Formatting failed" && exit 1)
          echo "üîç Clippy analysis (includes build) with -D warnings..."
          cargo clippy --workspace --all-targets --release --quiet -- -D warnings && echo "   ‚úì Clippy OK" || (echo "   ‚úó Clippy failed" && exit 1)
          echo "üß™ Unit tests (core + macros)..."
          cargo test -p lithair-core -p lithair-macros --release --quiet && echo "   ‚úì Tests OK" || (echo "   ‚úó Tests failed" && exit 1)
          echo "üéâ CI completed successfully!"

      - name: Ensure demo scripts are executable
        run: |
          chmod +x examples/http_firewall_demo/run_demo.sh
          chmod +x examples/http_firewall_demo/run_declarative_demo.sh
          chmod +x examples/http_hardening_demo/run_demo.sh
          chmod +x tests/frontend_benchmark/run_frontend_demo.sh
          chmod +x examples/raft_replication_demo/bench_http_server_stateless.sh

      - name: Smoke - Firewall demo (configurable)
        run: |
          PORT=19100 bash examples/http_firewall_demo/run_demo.sh

      - name: Smoke - Firewall demo (model-level declarative)
        run: |
          PORT=19101 bash examples/http_firewall_demo/run_declarative_demo.sh

      - name: Smoke - HTTP hardening demo
        run: |
          PORT=19102 bash examples/http_hardening_demo/run_demo.sh

      - name: Smoke - Frontend benchmark (static + API)
        run: |
          PORT=19103 bash tests/frontend_benchmark/run_frontend_demo.sh

      - name: Smoke - Stateless perf endpoints (fast)
        env:
          CONCURRENCY: 64
          TIMEOUT_S: 10
          PORT: 19104
          TOTAL_STATUS: 2000
          TOTAL_JSON_1KB: 2000
          TOTAL_BYTES_1KB: 2000
          TOTAL_ECHO_1KB: 1000
          RS_PERF_MAX_BYTES: 262144
        run: |
          bash examples/raft_replication_demo/bench_http_server_stateless.sh
